<!DOCTYPE html>
<html>

<head>
    <title>Carte Google Maps UNKRA</title>
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCtdy9oLt_yR5nNM0FsJJGQwCoIMlndwZs&libraries=geometry"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>

        function showSidebarBtn(show) {
            var btn = document.getElementById('openSidebarBtn');
            if (btn) btn.style.display = show ? 'flex' : 'none';
        }
        function updateSidebarBtnVisibility() {
            var openBtn = document.getElementById('openSidebarBtn');
            if (!openBtn) return;

            // Vérifie quel onglet est actif
            var activeTab = document.querySelector('.tab-btn.active');
            if (activeTab && activeTab.dataset.tab === 'mapTab') {
                openBtn.style.display = 'flex';
            } else {
                openBtn.style.display = 'none';
            }
        }

        function exportChart() {
            const url = window.statsChart.toBase64Image();
            const link = document.createElement('a');
            link.href = url;
            link.download = 'statistiques_poteaux.png';
            link.click();
        }

        function exportStats() {
            const rows = [
                ["Type", "Nombre de poteaux"],
                ["DEPART", tailleDepart],
                ["BRANCHE", tailleBranche],
                ["CABINE", tailleCabine],
                ["PN7", taillePoche7],
                ["PN8", taillePoche8],
                ["PN9", taillePoche9],
                ["PN11", taillePoche11]
            ];
            let csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
            const link = document.createElement("a");
            link.href = encodeURI(csvContent);
            link.download = "statistiques_poteaux.csv";
            link.click();
        }

        function updateKPI() {
            const values = [tailleDepart, tailleBranche, tailleCabine, taillePoche7, taillePoche8, taillePoche9, taillePoche11];
            const labels = ['DEPART', 'BRANCHE', 'CABINE', 'PN7', 'PN8', 'PN9', 'PN11'];
            const total = values.reduce((a, b) => a + b, 0);
            const maxIndex = values.indexOf(Math.max(...values));
            const minIndex = values.indexOf(Math.min(...values));

            document.getElementById('totalPoteaux').textContent = total;
            document.getElementById('typeMax').textContent = `${labels[maxIndex]} (${values[maxIndex]})`;
            document.getElementById('typeMin').textContent = `${labels[minIndex]} (${values[minIndex]})`;
        }

        /*function updateStatsTable() {
            const values = [tailleDepart, tailleBranche, tailleCabine, taillePoche7, taillePoche8, taillePoche9, taillePoche11];
            const labels = ['DEPART', 'BRANCHE', 'CABINE', 'PN7', 'PN8', 'PN9', 'PN11'];
            const total = values.reduce((a, b) => a + b, 0);
            const tbody = document.getElementById('statsTableBody');
            tbody.innerHTML = '';
            labels.forEach((lbl, i) => {
                const percent = ((values[i] / total) * 100).toFixed(1);
                tbody.innerHTML += `<tr><td>${lbl}</td><td>${values[i]}</td><td>${percent}%</td></tr>`;
            });
        }*/


        document.addEventListener('DOMContentLoaded', function () {
            // Gestion des onglets
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
                    this.classList.add('active');
                    const id = this.dataset.tab;
                    const el = document.getElementById(id);
                    if (el) el.style.display = 'block';
                    // Sécurise l'appel à setCenter
                    if (id === 'mapTab' && window.map && typeof window.map.setCenter === 'function') {
                        setTimeout(() => {
                            google.maps.event.trigger(window.map, 'resize');
                            window.map.setCenter({ lat: -4.510754, lng: 15.222594 });
                        }, 150);
                    }
                    if (id === 'statsTab') {
                        setTimeout(() => {
                            if (window.statsChart && typeof window.statsChart.update === 'function') window.statsChart.update();
                        }, 100);
                    }
                    updateSidebarBtnVisibility();
                });
            });

            function renderChart() {
                const ctxEl = document.getElementById('statsChart');


                if (!ctxEl) return;
                const ctx = ctxEl.getContext('2d');

                const dataArray = [
                    tailleDepart, tailleBranche, tailleCabine,
                    taillePoche7, taillePoche8, taillePoche9, taillePoche11
                ];

                if (window.statsChart instanceof Chart) {
                    window.statsChart.data.datasets[0].data = dataArray;
                    window.statsChart.update();
                    return;
                }

                window.statsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['DEPART', 'BRANCHE', 'CABINE', 'POCHE NOIRE 7', 'POCHE NOIRE 8', 'POCHE NOIRE 9', 'POCHE NOIRE 11'],
                        datasets: [{
                            label: 'Nombre de poteaux',
                            data: dataArray,
                            backgroundColor: [
                                '#00FFFF',
                                '#FF007F',
                                '#7C00FF',
                                '#00FF9C',
                                '#FF4500',
                                '#00BFFF',
                                '#FFD700',
                            ],
                            borderWidth: 2,
                            borderRadius: 8,
                            hoverBackgroundColor: [
                                '#33FFFF', '#FF33A6', '#A24BFF',
                                '#33FFB8', '#FF7043', '#33CFFF', '#FFE34C'
                            ],
                            hoverBorderWidth: 2,

                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }

            const originalUpdate = window.updateTailleDisplay;
            window.updateTailleDisplay = function () {
                if (typeof originalUpdate === 'function') originalUpdate();

                const src = document.getElementById('taillesContainer');
                const dst = document.getElementById('taillesContainerStats');
                if (src && dst) dst.innerHTML = src.innerHTML;

                renderChart();
                updateKPI();
                //updateStatsTable();
            };
            // Appel initial
            updateSidebarBtnVisibility();
            // Impression personnalisée (ajout du listener après chargement DOM)
            setTimeout(function () {
                const printBtn = document.getElementById('printBtn');
                if (!printBtn) return;

                printBtn.onclick = function () {
                    const printMap = document.getElementById('printMap').checked;
                    const printStats = document.getElementById('printStats').checked;

                    const mapTab = document.getElementById('mapTab');
                    const statsTab = document.getElementById('statsTab');
                    const tabs = document.querySelector('.tabs');
                    const sidebar = document.getElementById('sidebar');
                    const overlay = document.getElementById('sidebarOverlay');

                    // Sauvegarde des affichages initiaux
                    const mapTabDisplay = mapTab.style.display;
                    const statsTabDisplay = statsTab.style.display;
                    const tabsDisplay = tabs.style.display;
                    const sidebarDisplay = sidebar ? sidebar.style.display : '';
                    const overlayDisplay = overlay ? overlay.style.display : '';

                    // Création de l'en-tête d'impression
                    const header = document.createElement('div');
                    header.id = 'printHeader';
                    header.style.textAlign = 'center';
                    header.style.marginBottom = '20px';
                    header.innerHTML = `
      <h2 style="font-weight:bold;">THESE DE DOCTORAT</h2> 
      <hr>
      <p style="margin:4px 0;">OPTIMISATION DE LA MISE À LA TERRE EFFECTIVE DU
            NEUTRE BASÉE SUR LE SYSTÈME D’INFORMATION
            GÉOGRAPHIQUE POUR LA GESTION INTELLIGENTE DU
            RÉSEAU MOYENNE TENSION DE LA SOCIÉTÉ NATIONALE
            D’ÉLECTRICITÉ / KINSHASA - OUEST </p>
      <p style="margin:4px 0;"><strong>Auteur :</strong> Barthelemy MONKILA NKIWA</p>
      <p style="margin:4px 0;"><strong>Contact :</strong> +243 815 992 630 | +243 898 843 147 / bmonkila@isptkin.ac.cd | mnkiwa@gmail.com</p>
      <p style="margin:4px 0;"><strong>Date :</strong> ${new Date().toLocaleDateString()}</p>
      <hr style="margin-top:12px;">
    `;
                    document.body.insertBefore(header, document.body.firstChild);


                    const kpiContainer = document.getElementById('kpiContainer');
                    const printOptionsContainer = document.getElementById('printOptionsContainer');
                    const exportBtn = document.getElementById('exportBtn');

                    // Affiche uniquement les éléments cochés
                    mapTab.style.display = printMap ? 'block' : 'none';
                    statsTab.style.display = printStats ? 'block' : 'none';
                    /* kpiContainer.style.display = 'none';
                    printOptionsContainer.style.display = 'none';
                    exportBtn.style.display =  'none';*/

                    tabs.style.display = 'none';
                    if (sidebar) sidebar.style.display = 'none';
                    if (overlay) overlay.style.display = 'none';

                    

                    // Lancement de l'impression
                    setTimeout(() => {
                        window.print();

                        // Restaure l'affichage initial après impression
                        mapTab.style.display = mapTabDisplay;
                        statsTab.style.display = statsTabDisplay;
                        tabs.style.display = tabsDisplay;
                        if (sidebar) sidebar.style.display = sidebarDisplay;
                        if (overlay) overlay.style.display = overlayDisplay;

                        // Supprime l'en-tête d'impression
                        const headerEl = document.getElementById('printHeader');
                        if (headerEl) headerEl.remove();
                    }, 300);
                };
            }, 500);
        });
    </script>

    <script>
        let map;
        let markers = [];
        let polylines = [];
        let layers = {};
        let distanceLabels = [];

        let tailleDepart = 0;
        let tailleBranche = 0;
        let tailleCabine = 0;
        let taillePoche7 = 0;
        let taillePoche8 = 0;
        let taillePoche9 = 0;
        let taillePoche11 = 0;


        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: -4.510754, lng: 15.222594 },
                zoom: 15,
                styles: [
                    { "elementType": "geometry", "stylers": [{ "color": "#212121" }] },
                    { "elementType": "labels.text.fill", "stylers": [{ "color": "#757575" }] },
                    { "featureType": "road", "stylers": [{ "color": "#424242" }] },
                    { "featureType": "water", "stylers": [{ "color": "#000000" }] },
                    { "featureType": "landscape", "stylers": [{ "color": "#2a2a2a" }] }
                ]
            });


            loadGeoJSON("data/BRANCHE.geojson", "red", "Branche");
            loadGeoJSON("data/CABINE.geojson", "blue", "Cabine");
            loadGeoJSON("data/DEPART.geojson", "green", "Départ");
            //loadGeoJSON("data/POCHE.geojson", "yellow", "Poche Noire");
            loadGeoJSON("data/PN7.geojson", "olive", "Poche Noire 7");
            loadGeoJSON("data/PN8.geojson", "maroon", "Poche Noire 8");
            loadGeoJSON("data/PN9.geojson", "aqua", "Poche Noire 9");
            loadGeoJSON("data/PN11.geojson", "fuchsia", "Poche Noire 11");
            addSidebar();
        }

        function addSidebar() {
            let sidebar = document.createElement("div");
            sidebar.id = "sidebar";
            sidebar.innerHTML = `
                <button id="toggleSidebar">☰</button>
                <div id="sidebarContent">
                    <h3>Les données</h3>
                    <div id="layerControls"></div>
                    <div id="layerControls"></div>
                    <h3>Légende</h3>
                    <p><span style="color: red;">⬤</span> PAF (Poteau à angle Fort)</p>
                    <p><span style="color: blue;">⬤</span> Poteau</p>
                    <p><span style="color: green;">⬤</span> PAL (Poteau d'alignement)</p>
                    <p><span style="color: yellow;">⬤</span> PAM (Poteau à angle Moyen)</p>
                    <div id="layerControls"></div>
                    <div id="layerControls"></div>
                    <h3>La taille</h3>
                   <div id="taillesContainer">
                        <p> DEPART : 0 Poteaux</p>
                        <p> BRANCHE : 0 Poteaux</p>
                        <p> CABINE : 0 Poteaux</p>
                        <p> POCHE NOIRE 7 : 0 Poteaux</p>
                        <p> POCHE NOIRE 8 : 0 Poteaux</p>
                        <p> POCHE NOIRE 9 : 0 Poteaux</p>
                        <p> POCHE NOIRE 11 : 0 Poteaux</p>
                   </div>
                   <div id="layerControls"></div>
                </div>
            `;
            document.body.appendChild(sidebar);
            // Gestion sidebar/overlay ici
            const overlay = document.getElementById('sidebarOverlay');
            const openBtn = document.getElementById('openSidebarBtn');
            const toggleBtn = document.getElementById('toggleSidebar');
            // Ouvre le sidebar
            openBtn.addEventListener('click', function (e) {
                sidebar.classList.add('open');
                overlay.style.display = 'block';
                setTimeout(() => overlay.style.opacity = 1, 10);
                showSidebarBtn(false);
                e.stopPropagation();
            });
            // Ferme le sidebar
            overlay.addEventListener('click', function () {
                sidebar.classList.remove('open');
                overlay.style.opacity = 0;
                setTimeout(() => overlay.style.display = 'none', 300);
                showSidebarBtn(true);
            });
            toggleBtn.addEventListener('click', function (e) {
                sidebar.classList.remove('open');
                overlay.style.opacity = 0;
                setTimeout(() => overlay.style.display = 'none', 300);
                showSidebarBtn(true);
                e.stopPropagation();
            });
            // Empêche le clic sur le sidebar de fermer
            sidebar.addEventListener('click', function (e) { e.stopPropagation(); });
        }

        function loadGeoJSON(url, color, label) {


            fetch(url)
                .then(response => response.json())
                .then(data => {
                    let path = [];
                    let group = [];
                    let newLabel = "AUTRES";

                    let taille = data.features.length;

                    if (label == "Branche") {
                        tailleBranche += taille;
                    } else if (label == "Cabine") {
                        tailleCabine += taille;
                    } else if (label == "Départ") {
                        tailleDepart += taille;
                    } else if (label == "Poche Noire 7") {
                        taillePoche7 += taille;
                    } else if (label == "Poche Noire 8") {
                        taillePoche8 += taille;
                    } else if (label == "Poche Noire 9") {
                        taillePoche9 += taille;
                    } else if (label == "Poche Noire 11") {
                        taillePoche11 += taille;
                    }

                    updateTailleDisplay();

                    data.features.forEach(feature => {

                        let coords = feature.geometry.coordinates;
                        let name = feature.properties.Name || feature.properties.id;
                        let description = feature.properties.description || "Aucune";
                        let obersvation = feature.properties.observations || "Aucune";
                        //let poteauType = feature.properties.type_poteau || "Inconnu";
                        let poteauType = feature.type_poteau || feature.properties.type || "Inconnu";
                        let newColor = "";



                        if (poteauType == "PAF") {
                            newColor = "red";
                            newLabel = "PAF";
                        } else if (poteauType == "PAM") {
                            newColor = "yellow";
                            newLabel = "PAM";
                        } else if (poteauType == "PAL") {
                            newColor = "green";
                            newLabel = "PAL";
                        } else if (poteauType == "Inconnu") {
                            newColor = "blue";
                        } else {
                            newLabel = feature.properties.type;
                            newColor = "blue";
                        }

                        //let convertedCoords = utmToLatLng(coords[0], coords[1], 33, true);

                        let position;
                        if (isUTM(coords)) {
                            position = utmToLatLngWithProj4(coords[0], coords[1], 33);
                        } else {
                            position = { lat: coords[1], lng: coords[0] };
                        }

                        //console.log(position);



                        let marker = new google.maps.Marker({
                            position: position,
                            map: map,
                            title: name,
                            icon: {
                                url: `http://maps.google.com/mapfiles/ms/icons/${newColor}-dot.png`,
                                scaledSize: new google.maps.Size(30, 30)
                            },
                            animation: google.maps.Animation.DROP
                        });

                        let infoWindow = new google.maps.InfoWindow({
                            content: `<b>Nom : ${name}</b><br><b>Description :</b> ${description}<br><b>Type Poteau :</b> ${poteauType}<br><b>Obersvation:</b> ${description}`
                        });

                        marker.addListener("mouseover", () => {
                            marker.setAnimation(google.maps.Animation.BOUNCE);
                            infoWindow.open(map, marker);
                        });
                        marker.addListener("mouseout", () => {
                            marker.setAnimation(null);
                            infoWindow.close();
                        });

                        markers.push(marker);
                        group.push(marker);
                        path.push({ lat: coords[1], lng: coords[0] });
                    });

                    //console.log(`Nom: ${data.name} | Taille: ${taille}`)

                    if (path.length > 1) {
                        for (let i = 0; i < path.length - 1; i++) {
                            let distance = google.maps.geometry.spherical.computeDistanceBetween(
                                new google.maps.LatLng(path[i]),
                                new google.maps.LatLng(path[i + 1])
                            );
                            let midpoint = {
                                lat: (path[i].lat + path[i + 1].lat) / 2,
                                lng: (path[i].lng + path[i + 1].lng) / 2
                            };

                            let labelDiv = document.createElement("div");
                            labelDiv.style.position = "absolute";
                            labelDiv.style.color = "red";
                            labelDiv.style.fontSize = "14px";
                            labelDiv.style.fontWeight = "bold";
                            labelDiv.style.textShadow = "1px 1px 2px black";
                            labelDiv.innerHTML = `${(distance / 1000).toFixed(2)} km`;

                            let overlay = new google.maps.OverlayView();
                            overlay.onAdd = function () {
                                let layer = this.getPanes().overlayLayer;
                                layer.appendChild(labelDiv);
                            };

                            overlay.draw = function () {
                                let projection = this.getProjection();
                                let point = projection.fromLatLngToDivPixel(new google.maps.LatLng(midpoint.lat, midpoint.lng));
                                labelDiv.style.left = `${point.x}px`;
                                labelDiv.style.top = `${point.y}px`;
                            };

                            overlay.setMap(map);
                        }
                    }

                    let polyline = new google.maps.Polyline({
                        path: path,
                        geodesic: true,
                        strokeColor: "#FFFFFF",
                        strokeOpacity: 1.0,
                        strokeWeight: 2
                    });

                    /* polyline.setMap(map);
                    polylines.push(polyline);
                    group.push(polyline);*/

                    layers[label] = group;

                    addLayerControl(label);
                });
        }

        // Nouvelle structure pour gérer les couches par poche noire et sous-éléments
        const pocheNoireGroups = {
            'Poche Noire 7': [],
            'Poche Noire 8': [],
            'Poche Noire 9': [],
            'Poche Noire 11': []
        };
        const coucheTypes = ['Branche', 'Cabine', 'Départ', 'Poche Noire 7', 'Poche Noire 8', 'Poche Noire 9', 'Poche Noire 11'];

        function addLayerControl(label) {
            let container = document.getElementById("layerControls");
            // Regroupement par poche noire
            if (label.startsWith('Poche Noire')) {
                // Ajoute à la liste du groupe
                if (!pocheNoireGroups[label]) pocheNoireGroups[label] = [];
                pocheNoireGroups[label].push(label);
                // Si le bloc n'existe pas, on le crée
                let groupDiv = document.getElementById('group_' + label.replace(/\s/g, ''));
                if (!groupDiv) {
                    groupDiv = document.createElement('div');
                    groupDiv.id = 'group_' + label.replace(/\s/g, '');
                    groupDiv.style.marginBottom = '12px';
                    groupDiv.innerHTML = `<div style="font-weight:600;color:#007bff;margin-bottom:4px;">${label}</div><div class="poche-group-inner"></div>`;
                    container.appendChild(groupDiv);
                }
                let inner = groupDiv.querySelector('.poche-group-inner');
                // Ajoute le checkbox pour la poche noire globale
                if (!groupDiv.querySelector('.poche-global')) {
                    let pocheCb = document.createElement('input');
                    pocheCb.type = 'checkbox';
                    pocheCb.checked = true;
                    pocheCb.className = 'poche-global';
                    pocheCb.id = `layer_${label.replace(/\s/g, '')}_global`;
                    pocheCb.addEventListener('change', function () {
                        // Active/désactive tous les sous-checkbox
                        inner.querySelectorAll('input[type=checkbox]').forEach(cb => { cb.checked = this.checked; cb.dispatchEvent(new Event('change')); });
                    });
                    let pocheLabel = document.createElement('label');
                    pocheLabel.htmlFor = pocheCb.id;
                    pocheLabel.textContent = 'Tout afficher';
                    groupDiv.insertBefore(pocheCb, inner);
                    groupDiv.insertBefore(pocheLabel, inner);
                    groupDiv.insertBefore(document.createElement('br'), inner);
                }
                // Ajoute le sous-checkbox pour ce type précis
                let cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.checked = true;
                cb.id = `layer_${label.replace(/\s/g, '')}`;
                cb.addEventListener('change', function () {
                    toggleLayer(label, this.checked);
                });
                let labelElement = document.createElement('label');
                labelElement.htmlFor = cb.id;
                labelElement.textContent = 'Poteaux';
                inner.appendChild(cb);
                inner.appendChild(labelElement);
                inner.appendChild(document.createElement('br'));
                // Ajoute les sous-checkbox pour Cabine, Départ, Branche associés à cette poche noire
                ['Cabine', 'Départ', 'Branche'].forEach(type => {
                    let subLabel = `${type} (${label})`;
                    let subCb = document.createElement('input');
                    subCb.type = 'checkbox';
                    subCb.checked = true;
                    subCb.id = `layer_${type.replace(/\s/g, '')}_${label.replace(/\s/g, '')}`;
                    subCb.addEventListener('change', function () {
                        toggleLayer(subLabel, this.checked);
                    });
                    let subLabelElement = document.createElement('label');
                    subLabelElement.htmlFor = subCb.id;
                    subLabelElement.textContent = type;
                    inner.appendChild(subCb);
                    inner.appendChild(subLabelElement);
                    inner.appendChild(document.createElement('br'));
                });
                inner.appendChild(document.createElement('br'));
            }
            // Ne rien afficher pour les couches hors poche noire
        }

        function toggleLayer(label, show) {
            if (layers[label]) {
                layers[label].forEach(item => item.setMap(show ? map : null));
            }
        }

        function utmToLatLng(easting, northing, zoneNumber, northernHemisphere = true) {
            const a = 6378137.0;
            const e = 0.081819191;
            const k0 = 0.9996;

            const x = easting - 500000;
            const y = northernHemisphere ? northing : northing - 10000000;

            const lonOrigin = (zoneNumber - 1) * 6 - 180 + 3;

            const M = y / k0;
            const mu = M / (a * (1 - Math.pow(e, 2) / 4 - 3 * Math.pow(e, 4) / 64 - 5 * Math.pow(e, 6) / 256));

            const e1 = (1 - Math.sqrt(1 - Math.pow(e, 2))) / (1 + Math.sqrt(1 - Math.pow(e, 2)));

            const J1 = (3 * e1 / 2 - 27 * Math.pow(e1, 3) / 32);
            const J2 = (21 * Math.pow(e1, 2) / 16 - 55 * Math.pow(e1, 4) / 32);
            const J3 = (151 * Math.pow(e1, 3) / 96);
            const J4 = (1097 * Math.pow(e1, 4) / 512);

            const fp = mu + J1 * Math.sin(2 * mu) + J2 * Math.sin(4 * mu) + J3 * Math.sin(6 * mu) + J4 * Math.sin(8 * mu);

            const C1 = Math.pow(e * Math.cos(fp), 2) / (1 - Math.pow(e, 2));
            const T1 = Math.pow(Math.tan(fp), 2);
            const R1 = a * (1 - Math.pow(e, 2)) / Math.pow(1 - Math.pow(e * Math.sin(fp), 2), 1.5);
            const N1 = a / Math.sqrt(1 - Math.pow(e * Math.sin(fp), 2));

            const D = x / (N1 * k0);

            const lat = fp - (N1 * Math.tan(fp) / R1) *
                (Math.pow(D, 2) / 2 - (5 + 3 * T1 + 10 * C1 - 4 * Math.pow(C1, 2) - 9 * (e * e)) * Math.pow(D, 4) / 24
                    + (61 + 90 * T1 + 298 * C1 + 45 * Math.pow(T1, 2) - 252 * (e * e) - 3 * Math.pow(C1, 2)) * Math.pow(D, 6) / 720);

            const lng = lonOrigin + (D - (1 + 2 * T1 + C1) * Math.pow(D, 3) / 6
                + (5 - 2 * C1 + 28 * T1 - 3 * Math.pow(C1, 2) + 8 * (e * e) + 24 * Math.pow(T1, 2)) * Math.pow(D, 5) / 120) / Math.cos(fp);

            return {
                lat: lat * (180 / Math.PI),
                lng: lng * (180 / Math.PI)
            };
        }

        function isUTM(coords) {
            return coords[0] > 1000 && coords[0] < 1000000 && coords[1] > 9000000;
        }

        function utmToLatLngWithProj4(easting, northing, zone) {
            const utmProj = `+proj=utm +zone=${zone} +south +ellps=WGS84 +datum=WGS84 +units=m +no_defs`;
            const wgs84 = proj4('WGS84');
            const [lng, lat] = proj4(utmProj, wgs84, [easting, northing]);
            return { lat, lng };
        }

        // Ajout d'une fonction updateTailleDisplay globale pour éviter l'erreur
        function updateTailleDisplay() {
            var container = document.getElementById("taillesContainer");
            var statas = document.getElementById('totalStats');
            if (!container) return;
            container.innerHTML = `
                <p> DEPART : ${typeof tailleDepart !== 'undefined' ? tailleDepart : 0} Poteaux</p>
                <p> BRANCHE : ${typeof tailleBranche !== 'undefined' ? tailleBranche : 0} Poteaux</p>
                <p> CABINE : ${typeof tailleCabine !== 'undefined' ? tailleCabine : 0} Poteaux</p>
                <p> POCHE NOIRE 7 : ${typeof taillePoche7 !== 'undefined' ? taillePoche7 : 0} Poteaux</p>
                <p> POCHE NOIRE 8 : ${typeof taillePoche8 !== 'undefined' ? taillePoche8 : 0} Poteaux</p>
                <p> POCHE NOIRE 9 : ${typeof taillePoche9 !== 'undefined' ? taillePoche9 : 0} Poteaux</p>
                <p> POCHE NOIRE 11 : ${typeof taillePoche11 !== 'undefined' ? taillePoche11 : 0} Poteaux</p>
            `;

            if (statas) {
                let total = (typeof tailleDepart !== 'undefined' ? tailleDepart : 0) +
                    (typeof tailleBranche !== 'undefined' ? tailleBranche : 0) +
                    (typeof tailleCabine !== 'undefined' ? tailleCabine : 0) +
                    (typeof taillePoche7 !== 'undefined' ? taillePoche7 : 0) +
                    (typeof taillePoche8 !== 'undefined' ? taillePoche8 : 0) +
                    (typeof taillePoche9 !== 'undefined' ? taillePoche9 : 0) +
                    (typeof taillePoche11 !== 'undefined' ? taillePoche11 : 0);
                statas.innerHTML = ` ${total}`;
            }
        }


    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        body {
            font-family: 'Inter', Arial, sans-serif;
            background: #f4f7fa;
            margin: 0;
            color: #222;
        }

        /* Sidebar modernisé */
        #sidebar {
            position: fixed;
            top: 0;
            left: -320px;
            width: 320px;
            height: 100vh;
            background: #fff;
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.12);
            transition: left 0.4s cubic-bezier(.77, 0, .18, 1);
            z-index: 1200;
            border-top-right-radius: 18px;
            border-bottom-right-radius: 18px;
            padding: 0;
            overflow: hidden;
        }

        #sidebar.open {
            left: 0;
        }

        #sidebarContent {
            padding: 32px 24px 24px 24px;
            height: 100vh;
            overflow-y: auto;
        }

        #sidebar h3 {
            margin-top: 0;
            font-weight: 700;
            color: #007bff;
            letter-spacing: 1px;
        }

        #sidebar p,
        #sidebar label {
            font-size: 15px;
            margin: 0 0 8px 0;
        }

        #sidebar .legend-dot {
            display: inline-block;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
        }

        /* Overlay lors de l'ouverture du sidebar */
        #sidebarOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.25);
            z-index: 1100;
            transition: opacity 0.3s;
        }

        #sidebar.open~#sidebarOverlay {
            display: block;
            opacity: 1;
        }

        /* Bouton flottant d'ouverture sidebar */
        #openSidebarBtn {
            position: fixed;
            top: 70px;
            left: 18px;
            z-index: 1300;
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.13);
            font-size: 2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, box-shadow 0.2s;
            outline: none;
            opacity: 0.95;
        }

        #openSidebarBtn:hover {
            background: #0056b3;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.18);
        }

        #toggleSidebar {
            position: absolute;
            top: 18px;
            right: 18px;
            width: 36px;
            height: 36px;
            background: #f4f7fa;
            color: #007bff;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: background 0.2s;
        }

        #toggleSidebar:hover {
            background: #e3eaf3;
        }

        /* Tabs modernisées */
        .tabs {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            background: #fff;
            color: #222;
            z-index: 999;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.07);
            border-bottom: 1px solid #e3eaf3;
            height: 56px;
            align-items: center;
        }

        .tab-btn {
            flex: 1;
            padding: 0 0;
            height: 56px;
            border: none;
            cursor: pointer;
            background: transparent;
            color: #222;
            font-weight: 600;
            font-size: 1.08rem;
            letter-spacing: 0.5px;
            transition: color 0.2s, background 0.2s;
            border-bottom: 3px solid transparent;
            outline: none;
        }

        .tab-btn.active {
            color: #007bff;
            background: #f4f7fa;
            border-bottom: 3px solid #007bff;
            transition: background 0.3s, border-bottom 0.3s;
        }

        .tab-btn:not(.active):hover {
            background: #f4f7fa;
            color: #0056b3;
        }

        .tab-content {
            display: none;
            padding: 24px 18px 18px 18px;
            margin-top: 56px;
            height: calc(100vh - 56px);
            overflow-y: auto;
            animation: fadeIn 0.5s;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #map {
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.10);
            margin-top: 8px;
        }

        #statsChart {
            width: 100% !important;
            height: 420px !important;
            margin: 0 auto;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.07);
            padding: 18px;
        }

        /* Impression tab */
        #printTab label {
            font-size: 1.08rem;
            margin-bottom: 8px;
            display: block;
        }

        #printBtn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            background: linear-gradient(90deg, #007bff 60%, #0056b3 100%);
            color: white;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.10);
            transition: background 0.2s, box-shadow 0.2s;
        }

        #printBtn:hover {
            background: linear-gradient(90deg, #0056b3 60%, #007bff 100%);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.13);
        }

        /* Scrollbar custom */
        ::-webkit-scrollbar {
            width: 8px;
            background: #e3eaf3;
        }

        ::-webkit-scrollbar-thumb {
            background: #b3c6e0;
            border-radius: 8px;
        }

        /* Responsive */
        @media (max-width: 700px) {
            #sidebar {
                width: 90vw;
                left: -90vw;
            }

            #sidebar.open {
                left: 0;
            }

            #openSidebarBtn {
                left: 8px;
                top: 62px;
            }

            .tab-content {
                padding: 12px 4px 4px 4px;
            }
        }

        .kpi-container {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .kpi-card {
            background: #fff;
            padding: 16px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            flex: 1;
            text-align: center;
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .stats-table th,
        .stats-table td {
            border-bottom: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        @media print{
            #kpiContainer, #exportBtn,  #printOptionsContainer{
                display: none;
            }
        }
        
    </style>
</head>

<body onload="initMap()">
    <button id="openSidebarBtn" title="Afficher le menu"><span style="font-size:1.7rem;">☰</span></button>
    <div id="sidebarOverlay"></div>
    <!-- <div id="map" style="width: 100%; height: 600px;"></div> -->

    <!-- === TABS EN HAUT (remplace la div #map simple par ceci) === -->
    <div class="tabs">
        <button class="tab-btn active" data-tab="mapTab">Carte</button>
        <button class="tab-btn" data-tab="statsTab">Statistiques</button>
        <button class="tab-btn" data-tab="printTab">Impression</button>
        <!-- <button class="tab-btn" data-tab="helpTab">Aide</button> -->
        <button class="tab-btn" data-tab="aboutTab">À propos</button>
    </div>

    <div id="mapTab" class="tab-content active" style="display:block;">
        <div id="map" style="width: 100%; height: 550px; "></div>
    </div>

    <div id="statsTab" class="tab-content" style="display:none;padding:12px;">
        <div
            style="background:#fff;border-radius:14px;box-shadow:0 2px 12px rgba(0,0,0,0.07);padding:18px 20px 10px 20px;margin-bottom:18px;">
            <h3 style="color:#007bff;margin-top:0;">Résumé Statistiques</h3>
            <div id="taillesContainerStats" style="font-size:1.08rem;line-height:1.7;"></div>
            <hr>
            <div>Total: <span id="totalStats"></span></div>
        </div>



        <div class="kpi-container" id="kpiContainer">
            <div class="kpi-card">
                <h4>Total Poteaux</h4>
                <p id="totalPoteaux"></p>
            </div>
            <div class="kpi-card">
                <h4>Type le plus fréquent</h4>
                <p id="typeMax"></p>
            </div>
            <div class="kpi-card">
                <h4>Type le moins fréquent</h4>
                <p id="typeMin"></p>
            </div>
        </div>

        <!-- <select id="chartTypeSelect">
            <option value="bar">Barres</option>
            <option value="pie">Camembert</option>
            <option value="radar">Radar</option>
        </select> -->

        <div id="exportBtn">
            <button
            style="padding:12px 24px;border-radius:8px;border:none;background:linear-gradient(90deg,#007bff 60%,#0056b3 100%);color:white;cursor:pointer;font-size:1.1rem;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,0.10);transition:background 0.2s,box-shadow 0.2s;margin-top:12px;"
            onclick="exportStats()">
            Exporter CSV</button>
        <button
            style="padding:12px 24px;border-radius:8px;border:none;background:linear-gradient(90deg,#007bff 60%,#0056b3 100%);color:white;cursor:pointer;font-size:1.1rem;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,0.10);transition:background 0.2s,box-shadow 0.2s;margin-top:12px;"
            onclick="exportChart()">
            Exporter PDF</button>
        </div>

        



        <canvas id="statsChart" style="margin-top: 10px;"></canvas>

        <!-- <table class="stats-table">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Nombre de poteaux</th>
                    <th>Pourcentage</th>
                </tr>
            </thead>
            <tbody id="statsTableBody"></tbody>
        </table> -->

    </div>

    <div id="printTab" class="tab-content" style="display:none;padding:12px;">
        <div
            style="background:#fff;border-radius:14px;box-shadow:0 2px 12px rgba(0,0,0,0.07);padding:18px 20px 10px 20px;margin-bottom:18px;" id="printOptionsContainer">
            <h3 style="color:#007bff;margin-top:0;">Impression personnalisée</h3>
            <p style="font-size:1.08rem;">Choisissez les éléments à inclure dans l'impression :</p>
            <label style="margin-bottom:8px;"><input type="checkbox" id="printMap" checked> Inclure la carte</label><br>
            <label style="margin-bottom:8px;"><input type="checkbox" id="printStats" checked> Inclure les
                statistiques</label><br>
            <button id="printBtn"
                style="padding:12px 24px;border-radius:8px;border:none;background:linear-gradient(90deg,#007bff 60%,#0056b3 100%);color:white;cursor:pointer;font-size:1.1rem;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,0.10);transition:background 0.2s,box-shadow 0.2s;margin-top:12px;">
                Imprimer</button>
            <p style="font-size:0.98rem;color:#888;margin-top:10px;">Astuce : utilisez les cases à cocher pour
                personnaliser votre impression.</p>
        </div>
    </div>
    <div id="helpTab" class="tab-content" style="display:none;">
        <h2 style="color:#007bff;">Aide & FAQ</h2>
        <ul style="line-height:1.7;font-size:1.08rem;">
            <li><b>Comment utiliser la carte ?</b> Cliquez sur les couches à gauche pour afficher/masquer les données.
                Passez la souris sur les marqueurs pour plus d'infos.</li>
            <li><b>Comment imprimer ?</b> Allez dans l'onglet Impression et choisissez vos options.</li>
            <li><b>Problème d'affichage ?</b> Rafraîchissez la page ou contactez l'administrateur.</li>
        </ul>
        <p style="margin-top:18px;">Contact : <a href="mailto:support@unkra.org"
                style="color:#007bff;">support@unkra.org</a></p>
    </div>
    <div id="aboutTab" class="tab-content" style="display:none;">
        <h2 style="color:#007bff;">À propos</h2>
        <p style="font-size:1.08rem;">Ce projet cartographique est développé pour la visualisation et l'analyse des
            réseaux UNKRA.<br>Version 2025. UI modernisée et développée par Barthelemy MONKILA NKIWA.</p>
        <p style="margin-top:18px;">&copy; 2025 UNKRA. Tous droits réservés.</p>
    </div>
    <!-- === fin tabs === -->

</body>

</html>